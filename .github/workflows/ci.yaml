name: Go Web App CI Pipeline

# Exclude the workflow to run on changes to the helm chart
on:
  push:
    branches:
      - main
    paths-ignore:
      - 'helm/**'
      - 'k8s/**'
      - 'README.md'

jobs:

  build:
    runs-on: ubuntu-latest

    # üõ°Ô∏è Prevent CI from looping when it updates helm/values.yaml
    if: "!contains(github.event.head_commit.message, 'Update image tag to')"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v6
      with:
        go-version: '1.22.5'

    # üî® Build Go project
    - name: Build Go app
      run: go build -v ./...

    # ‚úÖ Run unit tests
    - name: Run tests
      run: go test -v ./...
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
       username: ${{ secrets.DOCKER_USERNAME }}
       password: ${{ secrets.DOCKER_TOKEN }}

    - name: Build and Push action
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/go-web-app:${{ github.sha }}

    # üìù Update Helm values.yaml with new image tag and push back to GitHub
    - name: Update Helm tag and commit
      run: |
        sed -i "s/^  tag: .*/  tag: \"${{ github.sha }}\"/" helm/values.yaml
        git config user.name "ci-bot"
        git config user.email "ci-bot@example.com"
        git add helm/values.yaml
        git commit -m "Update image tag to ${{ github.sha }}" || echo "No changes to commit"
        git push